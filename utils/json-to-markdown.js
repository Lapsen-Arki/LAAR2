const fs = require("fs");
const path = require("path");

const args = process.argv.slice(2);

const title = args[0] || "Backend Coverage Summary";
const filename =
  path.join("./results", args[1] + ".md") || "results/backend-summary.md";
const jsonPath =
  path.join("./results", args[2] + ".json") || "results/backend-summary.json";

fs.readFile(jsonPath, "utf8", function (err, data) {
  if (err) throw err;

  let jsonData = JSON.parse(data);
  let header =
    "St | Directory | Statements% | StCount | Branches% | BrCount | Functions% | FnCount | Lines% | LnCount";
  let separator = Object.keys(jsonData[0])
    .map(() => "---")
    .join(" | ");
  let rows = jsonData.map((obj) => Object.values(obj).join(" | ")).join("\n");

  let table = `| ${header} |\n| ${separator} |\n| ${rows} |`;
  let markdownContent = `# ${title}\n\n${table}\n`;
  let timestamp = new Date().toLocaleString();
  markdownContent += `\nGenerated by utils at ${timestamp}`;
  fs.writeFile(filename, markdownContent, "utf8", function (err) {
    if (err) throw err;
    console.log("Saved Markdown table to output.md: \n");
  });
});
